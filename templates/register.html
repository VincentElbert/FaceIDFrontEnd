<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Register</title>
    <style>
      :root {
        border-top: 8px solid #e3b18d;
      }
      
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
        background-color: #f2f2f2;
        font-family: Arial, sans-serif;
      }
      
      .card {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
        width: 400px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      
      .card-title {
        font-size: 24px;
        margin-bottom: 20px;
      }
      
      .form-group {
        margin-bottom: 20px;
        width: 100%;
      }
      
      label {
        display: block;
        margin-bottom: 5px;
        text-align: left;
      }
      
      input[type='email'],
      input[type='password'] {
        width: 100%;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
      }
      
      .error-message {
        color: red;
        margin-top: 5px;
        text-align: left;
      }
      
      .button {
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        cursor: pointer;
        border-radius: 5px;
      }
      
      .next-btn {
        background-color: #4caf50;
        color: white;
      }
      
      #webcam-container {
        margin-top: 20px;
        border-radius: 10px;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
      }
      
      #face-scan-instructions {
        margin-top: 20px;
        font-size: 18px;
        color: #666;
      }
      
      #loading {
        display: none;
        margin-top: 20px;
        font-size: 18px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h2 class="card-title">Register</h2>
      <form id="registration-form">
        <div class="form-group">
          <label for="email">Email:</label>
          <input type="email" id="email" name="email" required />
          <div class="error-message" id="email-error"></div>
        </div>
        <div class="form-group">
          <label for="password">Password:</label>
          <input type="password" id="password" name="password" required />
        </div>
        <div class="form-group">
          <label for="verify-password">Verify Password:</label>
          <input type="password" id="verify-password" name="verify-password" required />
          <div class="error-message" id="password-error"></div>
        </div>
        <button type="submit" class="button next-btn">Next</button>
      </form>
        <div id="webcam-container" style="display: none;">
          <video id="webcam" width="400" height="300" autoplay style="transform: scaleX(-1);"></video>
        </div>
        <div id="face-scan-instructions" style="display: none;"></div>
        <button id="pose-ready-btn" class="button" style="display: none;">Ready</button>
        <div id="loading" style="display: none;">Processing...</div>
      </div>

    <script>
      const registrationForm = document.getElementById('registration-form')
      const emailInput = document.getElementById('email')
      const passwordInput = document.getElementById('password')
      const verifyPasswordInput = document.getElementById('verify-password')
      const emailError = document.getElementById('email-error')
      const passwordError = document.getElementById('password-error')
      const webcamContainer = document.getElementById('webcam-container')
      const faceScanInstructions = document.getElementById('face-scan-instructions')
      const loading = document.getElementById('loading')
      const webcam = document.getElementById('webcam')
      
      registrationForm.addEventListener('submit', function (e) {
        e.preventDefault()
      
        if (!isValidEmail(emailInput.value)) {
          emailError.textContent = 'Please enter a valid email address.'
          return
        } else {
          emailError.textContent = ''
        }
      
        if (passwordInput.value !== verifyPasswordInput.value) {
          passwordError.textContent = 'Passwords do not match.'
          return
        } else {
          passwordError.textContent = ''
        }
      
        registrationForm.style.display = 'none'
        webcamContainer.style.display = 'block'
        faceScanInstructions.style.display = 'block'
        startFaceScan()
      })
      
      function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
        return emailRegex.test(email)
      }
      
      
      async function startFaceScan() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
          webcam.srcObject = stream

          const faceScanSteps = ['Front Face', 'Side of Face', 'Bottom of Face']
          const faceImages = []

          for (const step of faceScanSteps) {
            faceScanInstructions.textContent = `Please position yourself for ${step.toLowerCase()} scan.`
            faceScanInstructions.style.display = 'block'
            const poseReadyBtn = document.getElementById('pose-ready-btn')
            poseReadyBtn.style.display = 'block'

            await new Promise((resolve) => {
              poseReadyBtn.onclick = () => {
                poseReadyBtn.style.display = 'none'
                faceScanInstructions.textContent = `Scanning ${step.toLowerCase()}...`
                
                const captureImages = () => {
                  if (faceImages.length < 15) {
                    const canvas = document.createElement('canvas')
                    canvas.width = webcam.videoWidth
                    canvas.height = webcam.videoHeight
                    canvas.getContext('2d').drawImage(webcam, 0, 0, canvas.width, canvas.height)
                    const imageData = canvas.toDataURL('image/jpeg')
                    var blob = b64toBlob(imageData)
                    faceImages.push(blob)
                    setTimeout(captureImages, 200) // Capture image every 200ms
                  } else {
                    resolve()
                  }
                }
                captureImages()
              }
            })
          }

        faceScanInstructions.style.display = 'none'
        loading.style.display = 'block'

        const formData = new FormData();
        formData.append('email', emailInput.value);
        formData.append('password', passwordInput.value);
        formData.append('faceImages', faceImages)

        fetch('/register', {
        method: 'POST',
        body: formData
        })
          .then(response => {
            if (response.ok) {
              alert('Registration successful!');
              window.location.href = '/login';
            } else {
              alert('Registration failed. Please try again.');
            }
          })
          .catch(error => {
            console.error('Error during registration:', error);
            alert('An error occurred during registration. Please try again.');
          }); 
        }
      }

      function b64toBlob(base64) {
        var byteCharacters = atob(base64);
        var byteNumbers = new Array(byteCharacters.length);
        for (var i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        var byteArray = new Uint8Array(byteNumbers);
        return new Blob([byteArray], { type: 'image/jpeg' });
      }
    </script>
  </body>
</html>
