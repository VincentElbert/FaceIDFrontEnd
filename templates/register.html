<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Register & Face Scan</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/webcamjs/1.0.26/webcam.min.js"></script>
    <style>
      body,
      html {
        height: 100%;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: Arial, sans-serif;
        background-color: #f7f7f7;
      }
      .card {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        max-width: 340px;
        width: 100%;
        margin: 15px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
      }
      input[type='email'],
      input[type='password'] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-sizing: border-box;
      }
      .btn {
        padding: 10px 20px;
        width: 100%;
        border: none;
        border-radius: 5px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
      }
      .btn:disabled {
        background-color: #aaa;
      }
      .step {
        display: none;
      }
      .step.active {
        display: block;
      }
      #webcam-container {
        width: 100%;
        height: 240px;
        margin-bottom: 15px;
        border-radius: 5px;
        overflow: hidden;
        background: #000;
      }
      #webcam-container video {
        width: 100%;
        height: auto;
      }
    </style>
  </head>
  <body>
    <div class="card" id="registration-card">
      <h2>Register</h2>
      <form id="registration-form">
        <div class="form-group">
          <label for="email">Email:</label>
          <input type="email" id="email" required />
        </div>
        <div class="form-group">
          <label for="password">Password:</label>
          <input type="password" id="password" required />
        </div>
        <div class="form-group">
          <label for="confirm-password">Re-enter Password:</label>
          <input type="password" id="confirm-password" required />
        </div>
        <button type="submit" class="btn">Register & Scan Face ID</button>
      </form>
    </div>

    <div class="card step" id="step-1">
      <h2>Step 1: Scan Front of Face</h2>
      <div id="webcam-container"></div>
      <button class="btn" onclick="startScan(1)">Start Scan</button>
    </div>

    <div class="card step" id="step-2">
      <h2>Step 2: Scan Side of Face</h2>
      <div id="webcam-container"></div>
      <button class="btn" onclick="startScan(2)">Start Scan</button>
    </div>

    <div class="card step" id="step-3">
      <h2>Step 3: Scan Bottom of Face</h2>
      <p>Please move your face up.</p>
      <div id="webcam-container"></div>
      <button class="btn" onclick="startScan(3)">Start Scan</button>
    </div>

    <script>
      // Setup Webcam
      Webcam.set({
        width: 320,
        height: 240,
        image_format: 'jpeg',
        jpeg_quality: 90
      })
      
      let currentStep = 0
      const steps = ['registration-card', 'step-1', 'step-2', 'step-3']
      let scans = {} // Object to hold the base64 encoded images
      
      $('#registration-form').on('submit', function (e) {
        e.preventDefault()
        // Validate the form
        const email = $('#email').val()
        if (!email.includes('@')) {
          alert('Invalid email address!')
          return
        }
      
        // Validate passwords match
        const password = $('#password').val()
        const confirmPassword = $('#confirm-password').val()
        if (password !== confirmPassword) {
          alert('Passwords do not match!')
          return
        }
      
        // Hide registration card and show first step
        transitionToNextStep()
      })
      
      function startScan(stepNumber) {
        Webcam.snap(function (data_uri) {
          // Store the data_uri in the scans object
          scans[`step${stepNumber}`] = data_uri
      
          if (stepNumber < 3) {
            transitionToNextStep()
          } else {
            // All scans complete, send the data to the server
            sendScansToServer()
          }
        })
      }
      
      function sendScansToServer() {
        $.ajax({
          url: '/process_scans',
          type: 'POST',
          contentType: 'application/json; charset=utf-8',
          data: JSON.stringify(scans),
          dataType: 'json',
          success: function (response) {
            if (response.success) {
              alert('Face ID registration complete!')
              // Redirect or perform another action
            } else {
              alert('Error during scan processing. Please try again.')
            }
          },
          error: function (xhr, status, error) {
            alert('An error occurred while sending the scans. Please try again.')
          }
        })
      }
      
      // Utility function to switch to the next step
     // Utility function to switch to the next step
function transitionToNextStep() {
    let currentCard = $('#' + steps[currentStep])
    let nextCard = $('#' + steps[currentStep + 1])
    currentCard.hide()
    nextCard.show()
    
    // Detach the webcam before transitioning to the next step
    if (currentStep >= 0) {
      Webcam.reset()
    }
    
    currentStep++
    
    // Re-attach the webcam when transitioning to a step that requires scanning
    if (currentStep >= 1 && currentStep <= 3) {
      Webcam.attach('#webcam-container')
    }
  }
  
  // Initialize the first step on page load
  $(document).ready(function () {
    steps.forEach(function (step, index) {
      $('#' + step).hide()
    })
    $('#registration-card').show()
  })
  
  // Make the startScan function globally available
  window.startScan = startScan
    </script>
  </body>
</html>
