<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Register</title>
    <style>
      :root {
        border-top: 8px solid #e3b18d;
      }
      
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
        background-color: #f2f2f2;
        font-family: Arial, sans-serif;
      }
      
      .card {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
        width: 400px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      
      .card-title {
        font-size: 24px;
        margin-bottom: 20px;
      }
      
      .form-group {
        margin-bottom: 20px;
        width: 100%;  
      }
      
      label {
        display: block;
        margin-bottom: 5px;
        text-align: left;
      }
      
      input[type='email'],
      input[type='password'] {
        width: 100%;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
      }
      
      .error-message {
        color: red;
        margin-top: 5px;
        text-align: left;
      }
      
      .button {
        padding: 10px 20px;
        font-size: 16px;
        border: none;
        cursor: pointer;
        border-radius: 5px;
      }
      
        
        
        #webcam-container {
          margin-top: 20px;
          border-radius: 10px;
          overflow: hidden;
          display: flex;
          justify-content: center;
          align-items: center;
          width: 100%;
        }
        
        #face-scan-instructions {
          margin-top: 20px;
          font-size: 18px;
          color: #666;
        }
        
        #loading {
          display: none;
          margin-top: 20px;
          font-size: 18px;
          color: #666;
        }
        #popup {
          position: absolute;
          top: calc(50% - 100px);
          right: calc(40% - 180px);
          width: 200px;
          background-color: #fff;
          border: 1px solid #ccc;
          border-radius: 5px;
          padding: 10px;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          display: none;
          z-index: 1;
        }

        #popup-content {
          text-align: center;
        }

        #popup-title {
          font-size: 16px;
          margin-bottom: 5px;
        }

        #popup-message {
          font-size: 14px;
        }
    </style>
    <link rel="stylesheet" href="{{ url_for('static', filename = 'style.css') }}" />
  </head>
  <body>
    <div class="card">
      <h2 class="card-title">Register</h2>
      <form id="registration-form">
        <div class="form-group">
          <label for="email">Email:</label>
          <input type="email" id="email" name="email" required />
         
          <div class="error-message" id="email-error"></div>
        </div>
        <div class="form-group">
          <label for="password">Password:</label>
          <input type="password" id="password" name="password" required />
          <div id="popup" style="display: none;">
            <div id="popup-content">
              <h2 id="popup-title"></h2>
              <p id="popup-message"></p>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="verify-password">Confirm Password:</label>
          <input type="password" id="verify-password" name="verify-password" required />
          <div class="error-message" id="password-error"></div>
        </div>
        <button type="submit" class="button primary-button">Next</button>
      </form>
      <div id="webcam-container" style="display: none;">
        <video id="webcam" width="400" height="300" autoplay style="transform: scaleX(-1);"></video>
      </div>
      <div id="face-scan-instructions" style="display: none;"></div>
      <button id="pose-ready-btn" class="button primary-button" style="display: none;">Ready</button>
      <div id="loading" style="display: none;">Processing...</div>
    </div>
    <p>Already have an account? <a href="{{ url_for('login') }}" class="login-button">Login</a></p>
    <div class="footer">
        <p>&copy; FaceAuth Project</p>
    </div>

    <script>
      const registrationForm = document.getElementById('registration-form')
      const emailInput = document.getElementById('email')
      const passwordInput = document.getElementById('password')
      const verifyPasswordInput = document.getElementById('verify-password')
      const emailError = document.getElementById('email-error')
      const passwordError = document.getElementById('password-error')
      const webcamContainer = document.getElementById('webcam-container')
      const faceScanInstructions = document.getElementById('face-scan-instructions')
      const loading = document.getElementById('loading')
      const webcam = document.getElementById('webcam')
      
      registrationForm.addEventListener('submit', function (e) {
        e.preventDefault()
      
        if (!isValidEmail(emailInput.value)) {
          emailError.textContent = 'Please enter a valid email address.'
          return
        } else {
          emailError.textContent = ''
        }

        if (!isValidPassword(passwordInput.value)) {
          displayPopup('Password Error', 'Password must be at least 8 characters with a combination of uppercase letters, lowercase letters, numbers, and symbols')
          return
        } else {
          popup.style.display = 'none'
        }

        if (passwordInput.value !== verifyPasswordInput.value) {
          passwordError.textContent = 'Passwords do not match.'
          return
        } else {
          passwordError.textContent = ''
        }
      
        registrationForm.style.display = 'none'
        webcamContainer.style.display = 'block'
        faceScanInstructions.style.display = 'block'
        startFaceScan()
      })
      
      function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
        return emailRegex.test(email)
      }

      function isValidPassword(password) {
        const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,14}$/
        return passwordRegex.test(password)
      }
      
      function displayPopup(title, message) {
        const popup = document.getElementById('popup')
        const popupTitle = document.getElementById('popup-title')
        const popupMessage = document.getElementById('popup-message')

        popupTitle.textContent = title
        popupMessage.textContent = message

        popup.style.display = 'block'
      }

      async function startFaceScan() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
    webcam.srcObject = stream

    const faceScanSteps = ['Front Face', 'Side of Face', 'Bottom of Face']
    const faceImages = []

    for (const step of faceScanSteps) {
      count = 0
      faceScanInstructions.textContent = `Please position yourself for ${step.toLowerCase()} scan.`
      faceScanInstructions.style.display = 'block'
      const poseReadyBtn = document.getElementById('pose-ready-btn')
      poseReadyBtn.style.display = 'block'

      await new Promise((resolve) => {
        poseReadyBtn.onclick = () => {
          poseReadyBtn.style.display = 'none'
          faceScanInstructions.textContent = `Scanning ${step.toLowerCase()}...`

          const captureImages = () => {
            if (count < 15) {
              const canvas = document.createElement('canvas')
              canvas.width = webcam.videoWidth
              canvas.height = webcam.videoHeight
              canvas.getContext('2d').drawImage(webcam, 0, 0, canvas.width, canvas.height)
              const imageData = canvas.toDataURL('image/jpeg')
              faceImages.push(dataURItoBlob(imageData))
              count ++
              setTimeout(captureImages, 200) // Capture image every 200ms
            } else {
              resolve()
            }
          }
          captureImages()
        }
      })
    }

    faceScanInstructions.style.display = 'none'
    loading.style.display = 'block'

    const formData = new FormData()
    formData.append('email', emailInput.value)
    formData.append('password', passwordInput.value)
    faceImages.forEach((file, index) => {
      formData.append(`faceImages_${index}`, file, `faceImage_${index}.jpg`)
    })

    const response = await fetch('/register', {
      method: 'POST',
      body: formData
    })

    if (response.ok) {
      alert('Registration successful!')
      window.location.href = '/login'
    } else {
      alert('Registration failed. Please try again.')
    }
    } catch (error) {
      console.error('Error during face scan:', error)
      alert('An error occurred during face scan. Please try again.')
    } finally {
      webcam.srcObject.getTracks().forEach((track) => track.stop())
      loading.style.display = 'none'
    }
  }

      function dataURItoBlob(dataURI) {
        const byteString = atob(dataURI.split(',')[1])
        const mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0]
        const ab = new ArrayBuffer(byteString.length)
        const ia = new Uint8Array(ab)
        for (let i = 0; i < byteString.length; i++) {
          ia[i] = byteString.charCodeAt(i)
        }
        return new Blob([ab], { type: mimeString })
      }
    </script>
  </body>
</html>
